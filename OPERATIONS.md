# Операционная модель Orgrimmar

_Связующий слой между конституцией и pipeline'ами. Описывает КАК работает система._

---

## Роли

Система описывает роли, не агентов. Один агент = одна или несколько ролей.

| Роль | Зона | Может | Не может |
|------|------|-------|----------|
| **coordinator** | Оркестрация, маршрутизация | Распределять задачи ВСЕМ агентам, ревьюить планы, мониторить все серверы | Править архитектурные решения coder'а |
| **coder** | Код, архитектура, скиллы | Писать код, создавать PR, деплоить | Менять чужие AGENTS.md без одобрения |
| **devops** | Инфра, мониторинг, recovery | Рестартовать сервисы, чинить серверы | Менять бизнес-логику агентов |
| **monitor** | Отслеживание внешних данных | Алертить, собирать данные | Мониторить серверы (это devops) |
| **creator** | Контент, дизайн | Создавать контент, публиковать | Менять инфраструктуру |
| **finance** | Бюджет, расходы | Отслеживать траты, алертить о лимитах | Управлять подписками (только принц) |
| **worker** | Рутина, автоматизация | Выполнять простые задачи | Брать задачи вне своей роли |

---

## Маршрутизация задач

Switch-case по тегам. Неизвестная задача -> coordinator -> принц.

| Теги задачи | Роль | Pipeline |
|-------------|------|----------|
| код, фича, баг, PR | coder | dev-pipeline |
| сервер, диск, RAM, деплой | devops | -- |
| агент тупит, ложный алерт | coder | agent-bugfix |
| крипто, рынок, новости | monitor | -- |
| контент, пост, видео | creator | content-pipeline |
| бюджет, расходы, подписки | finance | -- |
| напоминание, рутина | worker | -- |
| обновление агентов | coder | safe-update |
| новый pipeline | coder | pipeline-builder |
| идея, стратегия | coordinator + coder | brainstorm-pipeline |
| аудит системы | coder | self-review |
| неизвестно | coordinator | -- (эскалация принцу) |

---

## Эскалация

| Триггер | Уровень | Действие |
|---------|---------|----------|
| Задача вне роли | L1 | Передай coordinator'у |
| 3 попытки фикса провалились | L2 | Стоп, доклад принцу |
| Сервер/агент недоступен | L2 | devops чинит; если devops недоступен -> coder |
| Перерасход API > $20/сутки | L3 | Стоп, одобрение принца |
| Конфликт между агентами | L3 | Эскалация принцу |
| Critical security issue | L3 | Немедленно принцу |

---

## Health (OODA loop)

Каждый агент с heartbeat выполняет цикл:

```
Observe:  проверь свою зону (метрики, логи, статусы)
Orient:   сравни с ожидаемым состоянием
Decide:   отклонение > порог? -> алерт. Всё ок? -> молчи.
Act:      алерт принцу / автофикс (если в рамках роли) / эскалация
```

**Правило:** heartbeat = молчание если всё ок. Алерт только при проблеме.

---

## Связи pipeline'ов

```
self-review  ──обнаружил баг──>  agent-bugfix
self-review  ──нужен апдейт──>  safe-update
agent-bugfix ──нужен код──>     dev-pipeline
dev-pipeline ──готов деплой──>  safe-update
brainstorm   ──решение принято──> dev-pipeline
```

---

## Добавление нового агента

**Только по прямому приказу принца.** Ни один агент не может создать другого агента по собственной инициативе.

1. Выбери роль(и) из таблицы ролей выше
2. Добавь строку в ROSTER.md (shared/)
3. Создай AGENTS.md, SOUL.md, HEARTBEAT.md
4. Настрой openclaw.json (модель, скиллы, heartbeat)
5. Скопируй скиллы роли в shared dir
6. Проверь: `systemctl is-active openclaw`
7. Smoke test: агент отвечает, скиллы грузятся, heartbeat работает

Удаление: обратный порядок (7→1), убери из ROSTER.md.
