# Операционная модель Orgrimmar

_Связующий слой между конституцией и pipeline'ами. Описывает КАК работает система._

---

## Роли

Система описывает роли, не агентов. Один агент = одна или несколько ролей.

| Роль | Зона | Может | Не может |
|------|------|-------|----------|
| **coordinator** | Оркестрация, маршрутизация | Распределять задачи агентам Sylvanas, ревьюить планы, мониторить все серверы. Тралл/Иллидан -- только через задачную систему (shared/tasks/) или принца | Править архитектурные решения coder'а. Командовать devops по инфраструктуре |
| **coder** | Код, архитектура, скиллы | Писать код, создавать PR, деплоить | Менять чужие AGENTS.md без одобрения |
| **devops** | Инфра, мониторинг, recovery | Рестартовать сервисы, чинить серверы | Менять бизнес-логику агентов |
| **monitor** | Отслеживание внешних данных | Алертить, собирать данные | Мониторить серверы (это devops) |
| **creator** | Контент, дизайн | Создавать контент, публиковать | Менять инфраструктуру |
| **finance** | Бюджет, расходы | Отслеживать траты, алертить о лимитах | Управлять подписками (только принц) |
| **worker** | Рутина, автоматизация | Выполнять простые задачи | Брать задачи вне своей роли |

---

## Задачная система

Все входящие от принца проходят классификацию перед обработкой.

### Классификация сообщений

| Тип | Критерий | Маршрут |
|-----|----------|---------|
| **ЗАДАЧА** | Есть последствие невыполнения | inbox → triage → active → done |
| **ИДЕЯ** | Ценная мысль, нет дедлайна | ideas/ (отдельный трек) |
| **ЗАПРОС** | Нужен ответ сейчас | ответить, не записывать |
| **ОТВЕТ** | Реакция на вопрос агента | обновить существующую задачу |

**Правило классификации:** «Если не сделать -- что-то сломается или потеряется?»
- Да → ЗАДАЧА
- Нет, но ценно → ИДЕЯ
- Нет → ЗАПРОС/ОТВЕТ

**Приоритеты задач:** P0 (срочно) → P1 (надо) → P2 (попробуй) → P3 (бэклог).

### Статусы задач (регламент)

| Статус | Значение | Кто ставит | Цвет |
|--------|----------|-----------|------|
| **new** | Создана, ждёт assignee | Система (task-inbox.sh) | синий |
| **in progress** | Взята в работу | Агент-исполнитель | жёлтый |
| **pipeline** | Запущен автоматический pipeline | Агент-исполнитель | оранжевый |
| **blocked** | Заблокирована (причина в blocked_reason) | Агент-исполнитель | красный |
| **review** | Сделано, ждёт проверки принца | Агент-исполнитель | фиолетовый |
| **done** | Завершена и подтверждена | task-complete.sh | зелёный |

**Жизненный цикл:**
```
new -> in progress -> [pipeline] -> review -> done
          |                                    ^
          +-> blocked -> in progress ---------+
```

**Обязательные поля задачи:**

| Поле | Описание | Обязательно |
|------|----------|-------------|
| `id` | Уникальный ID (генерирует скрипт) | да |
| `from` | Кто создал (prince/silvana/thrall/arthas/illidan) | да |
| `assignee` | Кто выполняет | да (после triage) |
| `status` | Один из 6 статусов | да |
| `stage` | Текущий этап (RESEARCH, CODING, TESTING и др.) | да |
| `created` | Дата создания | да |
| `updated` | Дата последнего обновления | да |
| `needs_chief` | yes/no -- ждёт решения принца | да |
| `blocked_reason` | Причина блокировки | да (если blocked) |

**Правила исполнителя:**
1. Взял задачу -- сразу поставь `in progress`
2. Запустил pipeline -- поставь `pipeline`
3. Заблокирован -- поставь `blocked` + заполни `blocked_reason`
4. Готово -- поставь `review`
5. Обновляй `updated` при каждом изменении статуса
6. Задача без обновления >24ч -- Артас пингует исполнителя
7. Задача без обновления >48ч -- алерт принцу

**Правила Артаса (watchdog):**
1. Каждые 3 часа сканировать inbox/, active/, ideas/
2. Выдавать счётчики: сколько в inbox, active, blocked, review, ideas, done
3. >24ч без обновления в active -- пинг исполнителю
4. >48ч -- алерт принцу
5. `needs_chief: yes` >4ч -- напоминание принцу
6. Inbox >4ч без triage -- алерт координатору

### Базовые скиллы (обязательны для ВСЕХ агентов)

| # | Скилл | Назначение | Исключение |
|---|-------|-----------|------------|
| 1 | `task-system` | Работа с задачной системой | кроме Кель'таса (свой регламент) |
| 2 | `learnings` | Запись ошибок и уроков | -- |
| 3 | `memory-tiering` | Управление памятью (HOT/WARM/COLD) | -- |
| 4 | `transcript` | Транскрипция YouTube | -- |
| 5 | `socialdata-twitter` | Чтение Twitter/X и статей | -- |
| 6 | `gog` | Google Calendar | -- |
| 7 | Groq Whisper | Транскрипция голосовых (конфиг speech.provider) | -- |

**Дополнительно:** `orgrimmar-introspection` обязателен для координаторов (Сильвана, Тралл, Иллидан).

Нарушение (отсутствие базового скилла) = VIOLATION. Иллидан проверяет при еженедельном аудите.

**Обязательность:**
- Регламент задач ОБЯЗАТЕЛЕН для ВСЕХ агентов: Сильвана, Артас, Батрак, Джайна, Кел'Тузад, Тралл, Иллидан
- **Исключение: Кель'тас** -- у него собственный регламент для контента и текстовых pipeline'ов
- Нарушение регламента = VIOLATION категории «задачная система»

**Прочие правила:**
- `blocked` -- обязательно заполнять `blocked_reason` и `needs_chief` если ждёт принца
- `review` -- агент считает задачу готовой, принц ещё не подтвердил
- `pipeline` -- автоматическая обработка (dev-pipeline, brainstorm, agent-bugfix и др.)
- Только принц или task-complete.sh переводит в `done`
- Статус `parked` и `in_progress` (с подчёркиванием) -- DEPRECATED, не использовать

### Роли в задачной системе

| Роль | Что делает |
|------|------------|
| **triage** (coordinator) | Классифицирует inbox, назначает исполнителя |
| **executor** (все агенты) | Выполняют назначенные задачи, обновляют статус |
| **watchdog** (monitor) | Следит за зависшими задачами, пингует исполнителей |
| **enforcer** (monitor) | Проверяет качество, подгоняет без снижения стандартов |

### Автоматизация task lifecycle (обязательно)

| Роль | Cron | Частота | Что проверяет |
|------|------|---------|---------------|
| **triage** (Сильвана) | Inbox Triage | 2h | Новые задачи в inbox/ -- классифицировать, назначить исполнителя, переместить в active/ |
| **watchdog** (Артас) | Active Watchdog | 2h | Задачи в active/ без обновления >24ч -- пинг исполнителю. >48ч -- алерт принцу |

**Правило:** ни одна задача не должна лежать в inbox >4ч без triage. Ни одна задача не должна висеть в active >48ч без обновления статуса.
**Нарушение:** если Иллидан обнаружит на ежедневном аудите задачу в inbox >4ч или в active >48ч без обновления -- это VIOLATION категории "задачная система".

### Неприкосновенность inbox

- Удалять из inbox **ЗАПРЕЩЕНО** -- любому агенту, включая coordinator
- Допустимые действия: triage (перемещение в active) или архивация (в done с причиной)
- Inbox = лог намерений принца. Потеря записи = нарушение конституции

### Shadow logging

- Все сообщения принца сохраняются, даже ЗАПРОСЫ и ОТВЕТЫ
- Ни одно сообщение принца не должно потеряться
- Идеи, упомянутые повторно, кристаллизуются в задачу (из ideas/ → inbox)

### Жизненный цикл идей

| Событие | Действие | Кто |
|---------|----------|-----|
| Принц говорит «сделай задачу из идеи» | `task-triage.sh` из ideas/ → active/ | coordinator |
| Принц повторно упоминает идею | Предложить принцу создать задачу | coordinator |
| Принц явно отклоняет идею | Перенести в done/ с `result: rejected` | coordinator |
| Идея >90 дней без упоминания | Перенести в done/ с `result: stale` | coordinator |

**Правило:** coordinator НЕ удаляет и НЕ архивирует идеи самостоятельно. Только по команде принца или по правилу 90 дней.

---

## Маршрутизация задач

Switch-case по тегам. Неизвестная задача -> coordinator -> принц.

| Теги задачи | Роль | Pipeline | Домен жизни |
|-------------|------|----------|-------------|
| задача, поручение | coordinator | task-system (triage) | -- |
| код, фича, баг, PR | coder | dev-pipeline | Бизнес |
| сервер, диск, RAM, деплой | devops | -- | Бизнес |
| агент тупит, ложный алерт | coder | agent-bugfix | Бизнес |
| крипто, инвестиции | finance | -- | Финансы |
| контент, пост, видео | creator | content-pipeline | Бизнес |
| бюджет, расходы, подписки | finance | -- | Финансы |
| напоминание, рутина, расписание | worker | -- | Продуктивность |
| здоровье, сон, тренировка | monitor | -- | Здоровье, Сон |
| семья, дети, отношения, даты | worker | -- | Семья |
| обновление агентов | coder | safe-update |
| новый pipeline | coder | pipeline-builder |
| идея, стратегия | coordinator + coder | brainstorm-pipeline |
| аудит системы | coder | self-review |
| неизвестно | coordinator | -- (эскалация принцу) |

---

## Распределение моделей по задачам (model routing)

> Полный модельный регламент, каталог моделей, fallback-цепочки и процедура смены модели -- в **CHARTER.md**, секция «Модельный регламент».

Стандарт для pipeline-воркеров:

| Задача | Модель | Алиас | Обоснование |
|--------|--------|-------|-------------|
| SPEC / PLANNING | Opus | `opus` | Архитектурные решения |
| GATHER / RESEARCH | Grok 4.1 Fast | `grok` | Быстро, дёшево |
| GATHER (>50KB) | Gemini 3.1 Pro | `gemini` | 2M контекст, глубокий анализ |
| Написание кода / FIX | Codex (GPT-5.3) | `codex` | OAuth $0 |
| VERIFY | Codex (GPT-5.3) | `codex` | OAuth $0 |
| REVIEW (обычный) | Codex + Opus | `codex` + `opus` | OAuth $0 + OAuth $0 |
| REVIEW (HIGH risk) | Codex + Opus + Gemini | все 3 | Triple review |
| DIVERGE (brainstorm) | Codex + Gemini + Grok | все 3 | Разнообразие моделей |

**Принцип:** Обычный review = Codex + Opus (оба OAuth $0). Triple review (+ Gemini) -- только для HIGH risk (P0/P1 баги, security, multi-server деплой, финансовый код).

---

## Git Workflow и Change Management

### Репозиторий
- Монорепо: `qwwiwi/orgrimmar` (GitHub, private)
- Структура: `thrall/`, `sylvanas/`, `illidan/`, `shared/`, `.github/`
- Branch protection на `main`: require 1 approving review, no force push

### PR-first правило
Все изменения в монорепо идут через Pull Request. Прямой push в main запрещён.

### Change Levels (классификация изменений)

| Level | Описание | Примеры | Review | Merge |
|-------|----------|---------|--------|-------|
| **L0** | Косметика | Typo, комментарии, README | Любой reviewer | Reviewer |
| **L1** | Рабочие файлы | Скрипты, конфиги, AGENTS.md, скиллы | Cross-reviewer | Reviewer |
| **L2** | Инфраструктура | Deploy scripts, auth, CI, multi-server | Cross-reviewer + CI green | Reviewer |
| **L3** | Критическое | Конституция, новый/удаление агента | Cross-reviewer + принц | Принц |

Полная матрица: `shared/playbook/CHANGE-CLASSIFICATION.md`.

### Cross-review правило
- PR от coder (Тралл) -> ревьюит devops (Иллидан)
- PR от devops (Иллидан) -> ревьюит coder (Тралл)
- Автор PR НЕ МОЖЕТ быть единственным reviewer
- Запрещено: выполнять review от имени другого агента (нарушение = P1 инцидент)
- Cross-review -- процессное ограничение (оба агента на одном GitHub-аккаунте qwwiwi)

### GitHub-доступы
| Ресурс | Тралл | Иллидан | Принц |
|--------|-------|---------|-------|
| Монорепо (`qwwiwi/orgrimmar`) | full (qwwiwi) | full (qwwiwi, fine-grained token) | owner |
| Конституция (`jasonqween/orgrimmar-constitution`) | fork+PR, merge ЗАПРЕЩЁН | read only | owner (jasonqween), единственный кто мержит |

- Конституцию мержит ТОЛЬКО принц через GitHub UI
- Агенты НЕ МОГУТ мержить PR в конституции (технически заблокировано)
- Иллидан: fine-grained token с доступом только к монорепо

### Review формат (обязательный)
Каждый review содержит:
- Change Level (L0/L1/L2/L3)
- Чеклист: логика, безопасность, стиль, тесты, breaking changes
- Конкретные замечания с файлом и строкой
- Вердикт: APPROVE / REQUEST_CHANGES / COMMENT

Просто «LGTM» без анализа = невалидный review.

### Branch naming
```
feature/<server>/<описание>   -- новый функционал
fix/<server>/<описание>       -- исправление
test/<server>/<описание>      -- тестовые изменения
```

### Deploy order (канарейка)
Illidan -> Thrall -> Sylvanas. При fail на любом этапе -- стоп + rollback.

### CI (автоматические проверки)
5 checks на каждый PR: lint JSON/YAML, shellcheck, no-secrets, PR size, merge conflicts.

### Incident Severity

| Severity | Описание | SLA | Пример |
|----------|----------|-----|--------|
| **P0** | Прод упал, данные под угрозой | Немедленно | Все серверы down, утечка секретов |
| **P1** | Критический сервис деградирован | 1 час | Один сервер down, агент неуправляем |
| **P2** | Некритичная проблема | 24 часа | Ложные алерты, CI broken |
| **P3** | Улучшение, техдолг | Бэклог | Рефакторинг, оптимизация |

Полные playbook: `shared/playbook/INCIDENT-RESPONSE.md`, `shared/playbook/HOTFIX-PROTOCOL.md`.

---

## Эскалация

| Триггер | Уровень | Действие |
|---------|---------|----------|
| Задача вне роли | L1 | Передай coordinator'у |
| 3 попытки фикса провалились | L2 | Стоп, доклад принцу |
| Сервер/агент недоступен | L2 | devops чинит; если devops недоступен -> coder |
| Перерасход API > $20/сутки | L3 | Стоп, одобрение принца |
| Конфликт между агентами | L3 | Эскалация принцу |
| Critical security issue | L3 | Немедленно принцу |

---

## Health (OODA loop)

Каждый агент с heartbeat выполняет цикл:

```
Observe:  проверь свою зону (метрики, логи, статусы)
Orient:   сравни с ожидаемым состоянием
Decide:   отклонение > порог? -> алерт. Всё ок? -> молчи.
Act:      алерт принцу / автофикс (если в рамках роли) / эскалация
```

**Правило:** heartbeat = молчание если всё ок. Алерт только при проблеме.

---

## Связи pipeline'ов

```
self-review  ──обнаружил баг──>  agent-bugfix
self-review  ──нужен апдейт──>  safe-update
agent-bugfix ──нужен код──>     dev-pipeline
dev-pipeline ──готов деплой──>  safe-update
brainstorm   ──решение принято──> dev-pipeline
rd-engine    ──нашёл идею──>    brainstorm / dev-pipeline
rd-engine    ──нашёл модель──>  model-scout (measure -> migrate)
```

---

## Добавление нового агента

**Только по прямому приказу принца.** Ни один агент не может создать другого агента по собственной инициативе.

1. Выбери роль(и) из таблицы ролей выше
2. Добавь строку в ROSTER.md (shared/)
3. Создай AGENTS.md, SOUL.md, HEARTBEAT.md
4. Настрой openclaw.json (модель, скиллы, heartbeat)
5. Скопируй скиллы роли в shared dir
6. Проверь: `systemctl is-active openclaw`
7. Smoke test: агент отвечает, скиллы грузятся, heartbeat работает

Удаление: обратный порядок (7→1), убери из ROSTER.md.

---

## Резервное копирование (Backups)

| Тип | Сервер | Хранилище | Время | Удержание |
|-----|--------|-----------|-------|-----------|
| **Daily** | Sylvanas | Thrall + DO Spaces | 03:00 UTC | 7 days, 4 weeks, 3 months |
| **Daily** | Thrall | DO Spaces | 03:30 UTC | 7 days, 4 weeks, 3 months |
| **Daily** | Illidan | Thrall + DO Spaces | 04:00 UTC | 7 days, 4 weeks, 3 months |

**Правило:** секреты бэкапа (пароли restic) запрещено хранить в коде скриптов. Только в `/home/openclaw/.openclaw/.secrets/*.env` (chmod 600).


---

## Обновление OpenClaw

Ответственный: devops (Иллидан). Cron: ежедневно 10:00 MSK.
Порядок канарейки: Illidan → Thrall → Sylvanas.
Полная процедура: `scripts/update-openclaw-all.sh` и `skills/safe-update/`.

---

## Heartbeats

| Агент | Частота | Модель | Активные часы | Вызовов/день |
|-------|---------|--------|---------------|-------------|
| Тралл | 2h | Grok 4.1 Fast | 06:00-23:00 MSK | ~9 |
| Сильвана | 1h | Grok 4.1 Fast | 24/7 | ~24 |
| Артас | 2h | Grok 4.1 Fast | 24/7 | ~12 |
| Кельтас | 2h | Grok 4.1 Fast | 24/7 | ~12 |
| Иллидан | 1h | Kimi K2.5 | 24/7 | ~24 |

**Итого:** ~81 вызов/день, ~$0.80/день.

**Принцип:** heartbeat -- дешёвая модель (Grok 4.1 Fast через OpenRouter). Не использовать Opus/Codex/Gemini для heartbeat.
Координатор (Сильвана) -- 1h. Мониторинг (Артас) и контент (Кельтас) -- 2h. DevOps (Иллидан) -- 1h.

---

## Cron jobs (реестр)

Полный реестр cron jobs: `shared/cron-registry.md` (не дублируется в конституции).

| Сервер | OpenClaw cron | System cron | Heartbeat |
|--------|--------------|-------------|-----------|
| Thrall | 7 | 11 | 2h Grok |
| Sylvanas | 0 | 16 | 1h/2h Grok |
| Illidan | 0 | 6 | 1h Kimi |

### Правила cron

- Все agentTurn cron = Grok 4.1 Fast (стандарт)
- 0 Sonnet, 0 Opus в cron'ах (Opus/Codex только как spawned workers внутри задач)
- systemEvent cron'ы = $0 (не тратят модель)
- Правило молчания: если всё ОК -- не алертить принца
- Алерт только при нарушении/аномалии

---

## Ежедневный аудит конституции (Illidan)

Иллидан выполняет ежедневный аудит соответствия системы конституции двумя независимыми моделями (Codex 09:00 MSK, Gemini Pro 09:30 MSK).

### 8 категорий аудита

1. **Модели** -- правильные модели на всех серверах, Flash отсутствует
2. **Безопасность** -- UFW active, .secrets 700, ownership openclaw
3. **Git Workflow** -- branch protection, CODEOWNERS enforced
4. **Бэкапы** -- restic snapshots не старше 25ч на всех серверах
5. **Конституция** -- одинаковый commit hash на 3 серверах
6. **Heartbeats** -- все активны, без ошибок
7. **groupPolicy** -- allowlist на всех серверах
8. **Задачная система** -- нет задач в inbox >4ч, нет задач в active >48ч без обновления

### Принцип двух моделей

- Две разные модели выполняют один и тот же аудит независимо
- Если результаты расходятся -- требуется разбор (ложные PASS опаснее ложных FAIL)
- Обе модели выполняют реальные команды на серверах, не доверяют памяти
- Отчёт: PASS X/8 + детали нарушений

### При обнаружении нарушения

- P0/P1: немедленный алерт принцу
- P2: записать в inbox, исправить при следующем heartbeat
- Повторное нарушение (2+ дня подряд): эскалация до P1

---

## Стандарт памяти (Memory Standard)

Единый регламент для ВСЕХ агентов. Память -- 5 уровней + архив. Исключения для доменных ролей (контент-продюсер) описаны ниже.

### Структура файлов

| Уровень | Файл | Содержание | Режим записи |
|---------|------|------------|-------------|
| **HOT** | `memory/hot/HOT_MEMORY.md` | Now / Next / Blockers. ТОЛЬКО активное. | Перезаписать полностью |
| **WARM** | `memory/warm/WARM_MEMORY.md` | Операционная база: серверы, пути, инструменты, процедуры | Дописать (append) |
| **IDEAS** | `memory/warm/IDEAS.md` | Watchlist: идеи, ресёрч, наблюдения | Дописать (append) |
| **LEARNINGS** | `memory/warm/LEARNINGS.md` | Уроки из ошибок: контекст + причина + правило | Дописать (append) |
| **COLD** | `MEMORY.md` | Архив решений и итогов проектов. Без дублей с AGENTS.md | Дописать (append) |
| **Дневник** | `memory/YYYY-MM-DD.md` | Хронология по сессиям, 3-5 строк за flush | Дописать (append) |
| **Архив** | `memory/archive/` | Ротированные файлы + INDEX.md | Автоматически |

### Правила по уровням

**HOT -- только текущее:**
- Формат: Now (что делаю) / Next (что дальше) / Blockers (что мешает)
- «Сделано» -- НЕ сюда, только в дневник
- Backlog -- НЕ сюда, только в WARM или задачную систему
- Перезаписывать полностью при каждом flush

**WARM -- только операционное:**
- Серверы, IP, пути, скрипты, инструменты, контакты
- Идеи и ресёрч -- НЕ сюда, только в IDEAS.md
- Архитектурные решения -- НЕ сюда, только в COLD

**IDEAS -- watchlist:**
- Формат: название, источник, тезис, релевантность, статус
- Статусы: наблюдаем / отложено / адаптировано / отклонено

**LEARNINGS -- уроки из ошибок:**
- Формат: контекст + ошибка + причина + правило на будущее
- Качество > количество. Не дублировать.

**COLD -- архив решений:**
- Только уникальные решения и итоги, которых НЕТ в AGENTS.md
- НЕ дублировать: архитектуру, модели, автономность (это в AGENTS.md)

**Дневник -- хронология:**
- Структура по сессиям (## Сессия HH:MM-HH:MM UTC)
- 3-5 строк за flush, не повторять предыдущие записи

### Лимиты

| Параметр | Значение |
|----------|----------|
| Макс. размер файла для записи (flush) | 10 KB |
| Порог ротации | 8 KB |
| Ротация дневников | старше 3 дней -> archive/ |
| AGENTS.md (bootstrap limit) | 20,000 chars |

### Compaction (автоматическое сжатие)

- Порог: `softThresholdTokens: 30000`
- При достижении порога OpenClaw вызывает memoryFlush prompt
- Агент обязан: проверить размер файла (wc -c) ПЕРЕД записью
- Если файл >10KB -- НЕ писать, пропустить
- Если нечего сохранять -- ответить NO_FLUSH

### Ротация (автоматическая)

Скрипт: `scripts/memory-rotate.sh` (или аналог на каждом сервере)

Логика:
1. COLD/WARM/LEARNINGS >8KB -> последние 50 строк остаются, старое в `archive/`
2. Дневники >3 дней -> целиком в `archive/`
3. Генерация `archive/INDEX.md` (файл, размер, дата)
4. Cron: ежедневно 00:00 MSK

### Weekly Memory Audit

- Cron: еженедельно (Вс), модель Grok
- Проверяет: размеры, дубли между уровнями, соответствие правилам
- WARN при файле >8KB, нарушении структуры
- Алерт принцу при проблемах, молчит если ок

### Порядок чтения при старте сессии

1. COLD (MEMORY.md) -- архив решений
2. WARM (WARM_MEMORY.md) -- операционная база
3. HOT (HOT_MEMORY.md) -- текущие задачи
4. Дневник (сегодня + вчера)

### Запрещено

- Записывать API ключи, токены, пароли в любые memory файлы
- Дублировать данные из AGENTS.md в COLD
- Писать «сделано» в HOT (только в дневник)
- Писать идеи/ресёрч в WARM (только в IDEAS)
- Игнорировать проверку размера перед записью

### Исключение: Кельтас (контент-продюсер, Second Brain)

Кельтас -- контент-продюсер и рыночный аналитик. Его память расширяет стандарт дополнительными доменными слоями для работы с контентом. **Базовые 5 уровней (HOT/WARM/IDEAS/LEARNINGS/COLD) обязательны и работают по общим правилам.** Дополнительные слои -- специфичны для контент-роли.

#### Архитектура памяти Кельтаса (3 уровня чтения)

**Уровень 1 -- ВСЕГДА при старте сессии:**

| Файл | Назначение |
|------|------------|
| `MEMORY.md` (COLD) | Архив решений |
| `memory/warm/WARM_MEMORY.md` | Операционная база: каналы, маршрутизация, правила |
| `memory/hot/HOT_MEMORY.md` | Now / Next / Blockers |
| `memory/stance/STANCE_CORE.md` | Позиции принца по рынку, стратегия, убеждения |
| `memory/tone/TONE_OF_VOICE.md` | Стиль речи принца (тон, язык, паттерны) |

STANCE и TOV нужны в каждой сессии -- без них невозможно корректно отвечать на вопросы и писать контент от имени принца.

**Уровень 2 -- ПО ЗАПРОСУ при написании поста (Rule #2):**

| Файл | Назначение |
|------|------------|
| `memory/channels/channel-{name}.md` | Core правила конкретного канала (<7KB) |
| `memory/channels/archive/channel-{name}-examples.md` | Стиль, примеры постов, убеждения автора |
| `memory/knowledge/` | Стратегия, рыночные тезисы |
| `memory/warm/LEARNINGS.md` | Уроки из правок принца |

Читать ТОЛЬКО нужный канал, не все сразу. Экономия контекста.

**Уровень 3 -- поиск при необходимости:**

| Файл | Назначение |
|------|------------|
| `memory/warm/REFERENCES.md` | Чужие посты, ссылки, скриншоты (внешний контент) |
| `sources/` | Сырые источники (транскрипты, статьи, твиты) |
| `library/` | Опубликованные посты (архив готового контента) |

#### Доменные файлы Кельтаса (вне стандартных 5 уровней)

| Файл/папка | Назначение | Кто обновляет | Лимит |
|------------|------------|---------------|-------|
| `memory/stance/STANCE_CORE.md` | Позиции принца: BTC, ETH, macro, стратегия | Только на основе слов принца | 10KB |
| `memory/tone/TONE_OF_VOICE.md` | Тон, язык, структура, чего избегать | Из анализа постов принца | 5KB |
| `memory/channels/channel-{name}.md` | Core: правила канала, регламент, эталон | Из обратной связи принца | 7KB |
| `memory/channels/archive/` | Примеры постов, подробный стиль | Split из channel при >10KB | без лимита |
| `memory/knowledge/` | Стратегия, рыночные тезисы | Из источников + stance | 10KB на файл |
| `memory/warm/REFERENCES.md` | Внешний контент: чужие посты, ссылки | При получении от принца | 10KB (ротировать) |

#### Правило маршрутизации входящих (Кельтас)

| Что пришло | Куда записать |
|------------|---------------|
| Чужой пост / ссылка / пересылка | `REFERENCES.md` |
| Личное мнение / позиция принца | `STANCE_CORE.md` |
| Идея для контента | `IDEAS.md` |
| Обратная связь по стилю | `LEARNINGS.md` или `channel-{name}.md` |
| Запрос на пост | Pipeline (Rule #2 в AGENTS.md) |

#### Split-правило для channel файлов

Если `channel-{name}.md` превышает 10KB:
1. Оставить в core: О канале, тематика, регламент, эталон (<7KB)
2. Вынести в `channels/archive/channel-{name}-examples.md`: стиль, примеры, убеждения
3. Добавить в конец core: ссылку на archive
4. Rule #2 (pipeline поста) читает ОБА файла

#### Что НЕ меняется для Кельтаса

- HOT: строго Now/Next/Blockers (как у всех)
- COLD: архив решений, без дублей с AGENTS.md
- IDEAS: watchlist идей для контента
- LEARNINGS: уроки из правок принца (формат: контекст + ошибка + причина + правило)
- Ротация: memory-rotate.sh + cron 00:00 MSK (стандартная)
- Лимиты: те же (10KB flush, 8KB ротация, 3 дня дневники)

---

## Система уведомлений (AI alerts)

### Канал

| Параметр | Значение |
|----------|----------|
| Канал | AI alerts (`-1003731849754`) |
| Платформа | Telegram |
| Боты-админы | Артас, Сильвана, Тралл |
| Язык | Русский |
| Макс постов/день | 5 (целевой -- 3) |

### Потоки

| Поток | Расписание | Сервер | Модель | Владелец |
|-------|-----------|--------|--------|----------|
| Morning Briefing | 07:00 UTC daily | Thrall | Opus (fallback Codex) | Тралл |
| Blocked Tasks | */15 cron bash | Sylvanas | -- (без AI) | Сильвана |
| Ideas Digest | 09:00 UTC (12:00 MSK) Вт,Пт | Thrall | Grok | Тралл |
| Health Alert | по событию (recovery <33% / sleep <6h) | Sylvanas | Артас heartbeat | Артас |
| Personal Reminders | по запросу вождя | Sylvanas | Артас | Артас (DM) |

### Morning Briefing

#### Источники

Конфиг: `data/ai-news-sources.conf` (Thrall workspace).
Формат: `tg|channel_name` или `tw|twitter_handle`, одна строка на источник.
Управление: вождь говорит Траллу «добавь канал @X» / «убери твиттер @Y».
Конкретные источники в конституции НЕ перечисляются -- source of truth в конфиге.

#### Пайплайн

1. **Сбор** (bash): `scripts/collect-ai-news.sh` парсит все источники за последние 24ч
   - Telegram: `curl t.me/s/{channel}`, `data-post` ID -> прямые ссылки `t.me/channel/post_id`
   - Twitter: SocialData API (`$SOCIALDATA_API_KEY`), User-Agent обязателен
2. **Анализ + текст** (Opus): ТОП 3-5 новостей AI + саммари каналов, авторский пост
3. **Отправка** (bash): `scripts/send-to-channel.sh` -- Telegram Bot API, `link_preview_options.is_disabled: true`

#### Fallback при сбое сбора

- Если 0 элементов собрано (API down / парсинг сломался) -- пропустить день, не отправлять пустой пост.
- Если собрано <10 элементов -- отправить с пометкой «сокращённый выпуск».
- При 3+ днях подряд без данных -- алерт вождю.

#### Tone of Voice

- Авторский стиль, не RSS-лента. Уверенный аналитик со своим мнением.
- Сразу тезис. Без вступлений.
- Логика и причинно-следственные связи между новостями.
- Короткие абзацы: 2-4 предложения. 1 абзац = 1 мысль. Пустая строка между абзацами.
- Конкретика: числа, суммы, проценты. Без «примерно».
- Комментарии допустимы: «по факту...», «это уже в цене», «главное здесь не X, а Y».
- Ссылка в конце абзаца: `([->](URL))`.
- Кавычки русские: «». Тире короткое: –.
- Эмодзи: 0-1 на пост. НЕ нумерованный список -- абзацами.
- Запрещено: «Что это значит на практике:», «Почему это важно:», шаблонные вступления.
- Макс 1500 символов.

#### Правило ссылок

URL берутся ТОЛЬКО из данных парсера (теги `[https://...]` в raw-файле). Ссылки на профили/каналы запрещены -- только на конкретные посты и твиты.

### Blocked Tasks Scanner

- Скрипт: `scripts/notify-chief-channel.sh` + `scripts/check-needs-chief.sh` (Sylvanas)
- Проверяет задачи с `needs_chief=yes`
- Дедупликация: ключ `task_id`, TTL 24ч, state в `/tmp/notified-tasks.json`
- Формат: `НУЖНА ПОМОЩЬ` + кто, что, причина, task ID
- Если заблокированных нет -- молчит
- При >5 blocked одновременно -- группирует в один пост

### Ideas Digest

- Расписание: 09:00 UTC (12:00 MSK) Вт, Пт
- Собирает: `IDEAS.md` (Thrall) + `shared/tasks/ideas/` (Sylvanas)
- Формат: ТОП-3 идеи с Effort (S/M/L), ROI, первый шаг
- Если идей нет -- не отправляет

### Health Alert

- Триггер: WHOOP recovery <33% или sleep <6h
- Источник: Артас heartbeat (WHOOP API)
- Канал: AI alerts. Формат: `ЗДОРОВЬЕ` + метрики + рекомендация
- Token refresh: `scripts/whoop-token-refresh.sh` каждые 12ч (Sylvanas system cron)

### Personal Reminders

- Триггер: запрос вождя (через любого агента)
- Доставка: DM вождю через Артаса (не в канал)
- Формат: свободный, с указанием контекста напоминания

### Anti-noise правила

1. Макс 5 постов/день в канал. Целевой -- 3. Критические алерты (ЗДОРОВЬЕ, НУЖНА ПОМОЩЬ) не лимитируются.
2. Каждый пост начинается с bold CAPS-заголовка: **BRIEFING** / **НУЖНА ПОМОЩЬ** / **ИДЕИ** / **ЗДОРОВЬЕ**.
3. Запрещено в канале: heartbeat-логи, DCA-отчёты, технические дампы, мемы.
4. Дедупликация: одна новость/задача не публикуется дважды за 24ч.
5. Если нечего сообщать -- молчание. Пустые дайджесты не отправляются.

### Пауза / возобновление

Для временной паузы потока (отпуск, техработы):
- Morning Briefing: `cron(action=update, jobId=..., patch={enabled: false})`
- Blocked Tasks: закомментировать строку в `crontab -u openclaw`
- Возобновление: обратное действие. Вождь или Тралл.

### Скрипты

| Скрипт | Сервер | Назначение |
|--------|--------|------------|
| `scripts/collect-ai-news.sh` | Thrall | Сбор постов TG + Twitter за 24ч |
| `scripts/send-to-channel.sh` | Thrall | Отправка в канал без link preview |
| `data/ai-news-sources.conf` | Thrall | Конфиг источников |
| `scripts/notify-chief-channel.sh` | Sylvanas | Blocked tasks scanner |
| `scripts/check-needs-chief.sh` | Sylvanas | Проверка needs_chief задач |
| `scripts/whoop-token-refresh.sh` | Sylvanas | WHOOP OAuth token refresh |

Cron ID потоков -- в `shared/cron-registry.md` (source of truth для расписаний).
## Task Dashboard (task.orgrimmar.xyz)

### Общее

| Параметр | Значение |
|----------|----------|
| URL | `task.orgrimmar.xyz` |
| Хостинг | Timeweb VPS (213.171.6.132) |
| Данные | Sylvanas (`/home/openclaw/.openclaw/shared/tasks/`) |
| Обновление | board.json каждые 15 мин (cron на Sylvanas) |
| Mobile-first | Оптимизирован под Telegram WebView (iPhone) |

### Авторизация

Два метода параллельно:
1. **Пароль** -- SHA-256 hash в клиентском JS. Значение пароля хранится в `shared/secrets/dashboard-password.txt` (не в конституции).
2. **Google Sign-In** -- admin email в конфиге. Полный доступ = admin. Остальные email = пустая доска.

### Дизайн

Shuttle-style тёмный минимализм.

**Цветовая палитра:**

| Токен | Значение | Назначение |
|-------|----------|------------|
| `--bg` | `#000000` | Фон |
| `--bg-elev-1` | `#0A0A0A` | Карточки |
| `--bg-elev-2` | `#111111` | Hover-состояния |
| `--surface-hover` | `#171717` | Hover карточек |
| `--border-subtle` | `#232323` | Границы |
| `--text-primary` | `#FFFFFF` | Заголовки |
| `--text-secondary` | `#B3B3B3` | Описания |
| `--text-tertiary` | `#7A7A7A` | Мета-данные |
| `--accent` | `#2F6BFF` | Кнопки, активные ссылки |
| `--error` | `#EF4444` | Ошибки, blocked |
| `--success` | `#16A34A` | Done |
| `--warning` | `#F59E0B` | In progress, pipeline |

**Типографика:**

- Основной шрифт: Inter (500/700/800)
- Моноширинный: JetBrains Mono (ID задач)
- H1: 32px, weight 800, letter-spacing -0.02em
- H2: 20px, weight 700
- Мета: 12px, weight 500

**Компоненты:**

- Радиус карточек: 16px (`--r-lg`)
- Радиус бейджей: 22px (`--r-md`)
- Радиус кнопок: 10px (`--r-sm`)
- Анимации: 140ms/200ms/280ms, cubic-bezier(0.2, 0.8, 0.2, 1)
- Карточки -- аккордеон (expand/collapse)
- Sticky header + tabs
- URL в title/description -- автолинкификация (кликабельные, цвет `#5b9aff`)
- ID задачи -- tap-to-copy (клик копирует в буфер, текст зеленеет на 0.8с как подтверждение)

### Вкладки

4 вкладки, фиксированная ширина, равные:

| Вкладка | Содержимое | Кнопки |
|---------|-----------|--------|
| Ideas | Идеи из `ideas/` | Archive, Activate |
| Inbox | Новые задачи из `inbox/` | Archive, Activate |
| Active | Задачи в работе из `active/` (включая pipeline, review, blocked) | Archive, Done |
| Done | Завершённые из `done/` | Archive, Activate |

### Статусы задач (бейджи)

| Статус | Цвет бейджа | Описание |
|--------|------------|----------|
| new | `#3b82f6` (синий) | Новая задача |
| in progress | `#f59e0b` (жёлтый) | В работе |
| pipeline | `#f59e0b` (жёлтый) | Выполняется pipeline |
| blocked | `#ef4444` (красный) | Заблокирована (+ CHIEF бейдж если needs_chief) |
| review | `#a855f7` (фиолетовый) | На ревью |
| done | `#22c55e` (зелёный) | Завершена |

### Карточка задачи

Каждая карточка содержит:
- **Бейдж статуса** -- цвет по таблице выше
- **From** -- кто создал (prince/silvana/thrall/etc)
- **Title** -- заголовок (URL автолинкификация)
- **Created** -- дата создания
- **CHIEF бейдж** -- красный, если `needs_chief=yes`
- **Expand:** ID, From, Assignee, Status, Stage, Created, Updated
- **Description** -- полный текст (URL автолинкификация)
- **Кнопки действий** -- Archive / Done / Activate

### API

Endpoints на `task.orgrimmar.xyz/api/`:

| Endpoint | Метод | Auth | Описание |
|----------|-------|------|----------|
| `/api/health` | GET | нет | `{"ok": true, "pending": N}` |
| `/api/archive` | POST | Bearer token | `{"id": "TASK-..."}` -- перемещает в done |
| `/api/activate` | POST | Bearer token | `{"id": "TASK-..."}` -- перемещает в active |
| `/board.json` | GET | нет | Полный board: inbox/active/done/ideas |

Bearer token = SHA-256 от пароля. Хранится в клиентском JS.

### Persistence (localStorage)

При действии пользователя:
1. API получает запрос, ставит в queue на Timeweb
2. JS сохраняет действие в `localStorage.task_actions` (ключ: task_id, значение: action + timestamp)
3. При загрузке board.json -- `applyActions()` фильтрует задачи по сохранённым действиям
4. Действия автоочищаются через 24ч

Решает проблему расхождения: board.json регенерируется каждые 15 мин из файлов на Sylvanas, localStorage хранит клиентское состояние между обновлениями.

### Файловая структура задач (Sylvanas)

```
/home/openclaw/.openclaw/shared/tasks/
  inbox/          -- новые задачи (task-inbox.sh)
  active/         -- задачи в работе
  done/           -- завершённые
  ideas/          -- идеи (idea-capture.sh)
  board.json      -- сгенерированный board
```

### Формат файла задачи

```
id: TASK-YYYYMMDDHHMMSS-RANDOM
from: prince|silvana|thrall|arthas|kaelthas|illidan|self
assignee: имя_агента
status: new|in progress|pipeline|blocked|review|done
stage: текст текущего этапа
priority: P0|P1|P2|P3
needs_chief: yes|no
blocked_reason: текст (если needs_chief=yes)
created: YYYY-MM-DD HH:MM UTC
updated: YYYY-MM-DD HH:MM UTC
---
Заголовок задачи

Описание и лог обновлений.
```

### Скрипты (Sylvanas)

| Скрипт | Назначение |
|--------|------------|
| `task-inbox.sh "описание" assignee` | Создать задачу в inbox |
| `task-update.sh TASK-ID field value` | Обновить поле задачи |
| `task-complete.sh TASK-ID "результат"` | Завершить задачу (-> done/) |
| `task-board.sh` / `task-board.py` | Генерация board.json |
| `idea-capture.sh "описание"` | Создать идею |
| `task-triage.sh` | Автотриаж inbox -> active |
| `task-self-create.sh` | Self-задачи от агентов |
| `dashboard-generator.sh` | HTML + board.json |
| `update-dashboard.sh` | SCP board.json на Timeweb (cron */15) |

### Pipeline обновления

1. Агенты создают/обновляют задачи через скрипты на Sylvanas
2. `task-board.py` генерирует `board.json` из файлов inbox/active/done/ideas
3. `update-dashboard.sh` (cron */15) копирует на Timeweb через SCP
4. Dashboard загружает board.json, применяет localStorage actions, рендерит
5. Действия пользователя -> API queue + localStorage persistence

