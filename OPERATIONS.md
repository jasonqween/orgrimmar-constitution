# Операционная модель Orgrimmar

_Связующий слой между конституцией и pipeline'ами. Описывает КАК работает система._

---

## Роли

Система описывает роли, не агентов. Один агент = одна или несколько ролей.

| Роль | Зона | Может | Не может |
|------|------|-------|----------|
| **coordinator** | Оркестрация, маршрутизация | Распределять задачи агентам Sylvanas, ревьюить планы, мониторить все серверы. Тралл/Иллидан -- только через задачную систему (shared/tasks/) или принца | Править архитектурные решения coder'а. Командовать devops по инфраструктуре |
| **coder** | Код, архитектура, скиллы | Писать код, создавать PR, деплоить | Менять чужие AGENTS.md без одобрения |
| **devops** | Инфра, мониторинг, recovery | Рестартовать сервисы, чинить серверы | Менять бизнес-логику агентов |
| **monitor** | Отслеживание внешних данных | Алертить, собирать данные | Мониторить серверы (это devops) |
| **creator** | Контент, дизайн | Создавать контент, публиковать | Менять инфраструктуру |
| **finance** | Бюджет, расходы | Отслеживать траты, алертить о лимитах | Управлять подписками (только принц) |
| **worker** | Рутина, автоматизация | Выполнять простые задачи | Брать задачи вне своей роли |

---

## Задачная система

Все входящие от принца проходят классификацию перед обработкой.

### Классификация сообщений

| Тип | Критерий | Маршрут |
|-----|----------|---------|
| **ЗАДАЧА** | Есть последствие невыполнения | inbox → triage → active → done |
| **ИДЕЯ** | Ценная мысль, нет дедлайна | ideas/ (отдельный трек) |
| **ЗАПРОС** | Нужен ответ сейчас | ответить, не записывать |
| **ОТВЕТ** | Реакция на вопрос агента | обновить существующую задачу |

**Правило классификации:** «Если не сделать -- что-то сломается или потеряется?»
- Да → ЗАДАЧА
- Нет, но ценно → ИДЕЯ
- Нет → ЗАПРОС/ОТВЕТ

**Приоритеты задач:** P0 (срочно) → P1 (надо) → P2 (попробуй) → P3 (бэклог).

### Статусы задач (регламент)

| Статус | Значение | Кто ставит | Цвет |
|--------|----------|-----------|------|
| **new** | Создана, ждёт assignee | Система (task-inbox.sh) | синий |
| **in progress** | Взята в работу | Агент-исполнитель | жёлтый |
| **pipeline** | Запущен автоматический pipeline | Агент-исполнитель | оранжевый |
| **blocked** | Заблокирована (причина в blocked_reason) | Агент-исполнитель | красный |
| **review** | Сделано, ждёт проверки принца | Агент-исполнитель | фиолетовый |
| **done** | Завершена и подтверждена | task-complete.sh | зелёный |

**Жизненный цикл:**
```
new -> in progress -> [pipeline] -> review -> done
          |                                    ^
          +-> blocked -> in progress ---------+
```

**Обязательные поля задачи:**

| Поле | Описание | Обязательно |
|------|----------|-------------|
| `id` | Уникальный ID (генерирует скрипт) | да |
| `from` | Кто создал (prince/silvana/thrall/arthas/illidan) | да |
| `assignee` | Кто выполняет | да (после triage) |
| `status` | Один из 6 статусов | да |
| `stage` | Текущий этап (RESEARCH, CODING, TESTING и др.) | да |
| `created` | Дата создания | да |
| `updated` | Дата последнего обновления | да |
| `needs_chief` | yes/no -- ждёт решения принца | да |
| `blocked_reason` | Причина блокировки | да (если blocked) |

**Правила исполнителя:**
1. Взял задачу -- сразу поставь `in progress`
2. Запустил pipeline -- поставь `pipeline`
3. Заблокирован -- поставь `blocked` + заполни `blocked_reason`
4. Готово -- поставь `review`
5. Обновляй `updated` при каждом изменении статуса
6. Задача без обновления >24ч -- Артас пингует исполнителя
7. Задача без обновления >48ч -- алерт принцу

**Правила Артаса (watchdog):**
1. Каждые 3 часа сканировать inbox/, active/, ideas/
2. Выдавать счётчики: сколько в inbox, active, blocked, review, ideas, done
3. >24ч без обновления в active -- пинг исполнителю
4. >48ч -- алерт принцу
5. `needs_chief: yes` >4ч -- напоминание принцу
6. Inbox >4ч без triage -- алерт координатору

### Базовые скиллы (обязательны для ВСЕХ агентов)

| # | Скилл | Назначение | Исключение |
|---|-------|-----------|------------|
| 1 | `task-system` | Работа с задачной системой | кроме Кель'таса (свой регламент) |
| 2 | `learnings` | Запись ошибок и уроков | -- |
| 3 | `memory-tiering` | Управление памятью (HOT/WARM/COLD) | -- |
| 4 | `transcript` | Транскрипция YouTube | -- |
| 5 | `socialdata-twitter` | Чтение Twitter/X и статей | -- |
| 6 | `gog` | Google Calendar | -- |
| 7 | Groq Whisper | Транскрипция голосовых (конфиг speech.provider) | -- |

**Дополнительно:** `orgrimmar-introspection` обязателен для координаторов (Сильвана, Тралл, Иллидан).

Нарушение (отсутствие базового скилла) = VIOLATION. Иллидан проверяет при еженедельном аудите.

**Обязательность:**
- Регламент задач ОБЯЗАТЕЛЕН для ВСЕХ агентов: Сильвана, Артас, Батрак, Джайна, Кел'Тузад, Тралл, Иллидан
- **Исключение: Кель'тас** -- у него собственный регламент для контента и текстовых pipeline'ов
- Нарушение регламента = VIOLATION категории «задачная система»

**Прочие правила:**
- `blocked` -- обязательно заполнять `blocked_reason` и `needs_chief` если ждёт принца
- `review` -- агент считает задачу готовой, принц ещё не подтвердил
- `pipeline` -- автоматическая обработка (dev-pipeline, brainstorm, agent-bugfix и др.)
- Только принц или task-complete.sh переводит в `done`
- Статус `parked` и `in_progress` (с подчёркиванием) -- DEPRECATED, не использовать

### Роли в задачной системе

| Роль | Что делает |
|------|------------|
| **triage** (coordinator) | Классифицирует inbox, назначает исполнителя |
| **executor** (все агенты) | Выполняют назначенные задачи, обновляют статус |
| **watchdog** (monitor) | Следит за зависшими задачами, пингует исполнителей |
| **enforcer** (monitor) | Проверяет качество, подгоняет без снижения стандартов |

### Автоматизация task lifecycle (обязательно)

| Роль | Cron | Частота | Что проверяет |
|------|------|---------|---------------|
| **triage** (Сильвана) | Inbox Triage | 2h | Новые задачи в inbox/ -- классифицировать, назначить исполнителя, переместить в active/ |
| **watchdog** (Артас) | Active Watchdog | 2h | Задачи в active/ без обновления >24ч -- пинг исполнителю. >48ч -- алерт принцу |

**Правило:** ни одна задача не должна лежать в inbox >4ч без triage. Ни одна задача не должна висеть в active >48ч без обновления статуса.
**Нарушение:** если Иллидан обнаружит на ежедневном аудите задачу в inbox >4ч или в active >48ч без обновления -- это VIOLATION категории "задачная система".

### Неприкосновенность inbox

- Удалять из inbox **ЗАПРЕЩЕНО** -- любому агенту, включая coordinator
- Допустимые действия: triage (перемещение в active) или архивация (в done с причиной)
- Inbox = лог намерений принца. Потеря записи = нарушение конституции

### Shadow logging

- Все сообщения принца сохраняются, даже ЗАПРОСЫ и ОТВЕТЫ
- Ни одно сообщение принца не должно потеряться
- Идеи, упомянутые повторно, кристаллизуются в задачу (из ideas/ → inbox)

### Жизненный цикл идей

| Событие | Действие | Кто |
|---------|----------|-----|
| Принц говорит «сделай задачу из идеи» | `task-triage.sh` из ideas/ → active/ | coordinator |
| Принц повторно упоминает идею | Предложить принцу создать задачу | coordinator |
| Принц явно отклоняет идею | Перенести в done/ с `result: rejected` | coordinator |
| Идея >90 дней без упоминания | Перенести в done/ с `result: stale` | coordinator |

**Правило:** coordinator НЕ удаляет и НЕ архивирует идеи самостоятельно. Только по команде принца или по правилу 90 дней.

---

## Маршрутизация задач

Switch-case по тегам. Неизвестная задача -> coordinator -> принц.

| Теги задачи | Роль | Pipeline | Домен жизни |
|-------------|------|----------|-------------|
| задача, поручение | coordinator | task-system (triage) | -- |
| код, фича, баг, PR | coder | dev-pipeline | Бизнес |
| сервер, диск, RAM, деплой | devops | -- | Бизнес |
| агент тупит, ложный алерт | coder | agent-bugfix | Бизнес |
| крипто, инвестиции | finance | -- | Финансы |
| контент, пост, видео | creator | content-pipeline | Бизнес |
| бюджет, расходы, подписки | finance | -- | Финансы |
| напоминание, рутина, расписание | worker | -- | Продуктивность |
| здоровье, сон, тренировка | monitor | -- | Здоровье, Сон |
| семья, дети, отношения, даты | worker | -- | Семья |
| обновление агентов | coder | safe-update |
| новый pipeline | coder | pipeline-builder |
| идея, стратегия | coordinator + coder | brainstorm-pipeline |
| аудит системы | coder | self-review |
| неизвестно | coordinator | -- (эскалация принцу) |

---

## Распределение моделей по задачам (model routing)

> Полный модельный регламент, каталог моделей, fallback-цепочки и процедура смены модели -- в **CHARTER.md**, секция «Модельный регламент».

Стандарт для pipeline-воркеров:

| Задача | Модель | Алиас | Обоснование |
|--------|--------|-------|-------------|
| SPEC / PLANNING | Opus | `opus` | Архитектурные решения |
| GATHER / RESEARCH | Grok 4.1 Fast | `grok` | Быстро, дёшево |
| GATHER (>50KB) | Gemini 3.1 Pro | `gemini` | 2M контекст, глубокий анализ |
| Написание кода / FIX | Codex (GPT-5.3) | `codex` | OAuth $0 |
| VERIFY | Codex (GPT-5.3) | `codex` | OAuth $0 |
| REVIEW (всегда) | Gemini 3.1 Pro | `gemini` | Обязателен в каждом review |
| REVIEW (HIGH risk) | Codex + Gemini + Opus | все 3 | Triple review |
| DIVERGE (brainstorm) | Codex + Gemini + Grok | все 3 | Разнообразие моделей |

**Принцип:** Gemini обязателен в каждом review. Triple review (3 модели) -- только для HIGH risk (P0/P1 баги, security, multi-server деплой, финансовый код).

---

## Git Workflow и Change Management

### Репозиторий
- Монорепо: `qwwiwi/orgrimmar` (GitHub, private)
- Структура: `thrall/`, `sylvanas/`, `illidan/`, `shared/`, `.github/`
- Branch protection на `main`: require 1 approving review, no force push

### PR-first правило
Все изменения в монорепо идут через Pull Request. Прямой push в main запрещён.

### Change Levels (классификация изменений)

| Level | Описание | Примеры | Review | Merge |
|-------|----------|---------|--------|-------|
| **L0** | Косметика | Typo, комментарии, README | Любой reviewer | Reviewer |
| **L1** | Рабочие файлы | Скрипты, конфиги, AGENTS.md, скиллы | Cross-reviewer | Reviewer |
| **L2** | Инфраструктура | Deploy scripts, auth, CI, multi-server | Cross-reviewer + CI green | Reviewer |
| **L3** | Критическое | Конституция, новый/удаление агента | Cross-reviewer + принц | Принц |

Полная матрица: `shared/playbook/CHANGE-CLASSIFICATION.md`.

### Cross-review правило
- PR от coder (Тралл) -> ревьюит devops (Иллидан)
- PR от devops (Иллидан) -> ревьюит coder (Тралл)
- Автор PR НЕ МОЖЕТ быть единственным reviewer
- Запрещено: выполнять review от имени другого агента (нарушение = P1 инцидент)
- Cross-review -- процессное ограничение (оба агента на одном GitHub-аккаунте qwwiwi)

### GitHub-доступы
| Ресурс | Тралл | Иллидан | Принц |
|--------|-------|---------|-------|
| Монорепо (`qwwiwi/orgrimmar`) | full (qwwiwi) | full (qwwiwi, fine-grained token) | owner |
| Конституция (`jasonqween/orgrimmar-constitution`) | fork+PR, merge ЗАПРЕЩЁН | read only | owner (jasonqween), единственный кто мержит |

- Конституцию мержит ТОЛЬКО принц через GitHub UI
- Агенты НЕ МОГУТ мержить PR в конституции (технически заблокировано)
- Иллидан: fine-grained token с доступом только к монорепо

### Review формат (обязательный)
Каждый review содержит:
- Change Level (L0/L1/L2/L3)
- Чеклист: логика, безопасность, стиль, тесты, breaking changes
- Конкретные замечания с файлом и строкой
- Вердикт: APPROVE / REQUEST_CHANGES / COMMENT

Просто «LGTM» без анализа = невалидный review.

### Branch naming
```
feature/<server>/<описание>   -- новый функционал
fix/<server>/<описание>       -- исправление
test/<server>/<описание>      -- тестовые изменения
```

### Deploy order (канарейка)
Illidan -> Thrall -> Sylvanas. При fail на любом этапе -- стоп + rollback.

### CI (автоматические проверки)
5 checks на каждый PR: lint JSON/YAML, shellcheck, no-secrets, PR size, merge conflicts.

### Incident Severity

| Severity | Описание | SLA | Пример |
|----------|----------|-----|--------|
| **P0** | Прод упал, данные под угрозой | Немедленно | Все серверы down, утечка секретов |
| **P1** | Критический сервис деградирован | 1 час | Один сервер down, агент неуправляем |
| **P2** | Некритичная проблема | 24 часа | Ложные алерты, CI broken |
| **P3** | Улучшение, техдолг | Бэклог | Рефакторинг, оптимизация |

Полные playbook: `shared/playbook/INCIDENT-RESPONSE.md`, `shared/playbook/HOTFIX-PROTOCOL.md`.

---

## Эскалация

| Триггер | Уровень | Действие |
|---------|---------|----------|
| Задача вне роли | L1 | Передай coordinator'у |
| 3 попытки фикса провалились | L2 | Стоп, доклад принцу |
| Сервер/агент недоступен | L2 | devops чинит; если devops недоступен -> coder |
| Перерасход API > $20/сутки | L3 | Стоп, одобрение принца |
| Конфликт между агентами | L3 | Эскалация принцу |
| Critical security issue | L3 | Немедленно принцу |

---

## Health (OODA loop)

Каждый агент с heartbeat выполняет цикл:

```
Observe:  проверь свою зону (метрики, логи, статусы)
Orient:   сравни с ожидаемым состоянием
Decide:   отклонение > порог? -> алерт. Всё ок? -> молчи.
Act:      алерт принцу / автофикс (если в рамках роли) / эскалация
```

**Правило:** heartbeat = молчание если всё ок. Алерт только при проблеме.

---

## Связи pipeline'ов

```
self-review  ──обнаружил баг──>  agent-bugfix
self-review  ──нужен апдейт──>  safe-update
agent-bugfix ──нужен код──>     dev-pipeline
dev-pipeline ──готов деплой──>  safe-update
brainstorm   ──решение принято──> dev-pipeline
rd-engine    ──нашёл идею──>    brainstorm / dev-pipeline
rd-engine    ──нашёл модель──>  model-scout (measure -> migrate)
```

---

## Добавление нового агента

**Только по прямому приказу принца.** Ни один агент не может создать другого агента по собственной инициативе.

1. Выбери роль(и) из таблицы ролей выше
2. Добавь строку в ROSTER.md (shared/)
3. Создай AGENTS.md, SOUL.md, HEARTBEAT.md
4. Настрой openclaw.json (модель, скиллы, heartbeat)
5. Скопируй скиллы роли в shared dir
6. Проверь: `systemctl is-active openclaw`
7. Smoke test: агент отвечает, скиллы грузятся, heartbeat работает

Удаление: обратный порядок (7→1), убери из ROSTER.md.

---

## Резервное копирование (Backups)

| Тип | Сервер | Хранилище | Время | Удержание |
|-----|--------|-----------|-------|-----------|
| **Daily** | Sylvanas | Thrall + DO Spaces | 03:00 UTC | 7 days, 4 weeks, 3 months |
| **Daily** | Thrall | DO Spaces | 03:30 UTC | 7 days, 4 weeks, 3 months |
| **Daily** | Illidan | Thrall + DO Spaces | 04:00 UTC | 7 days, 4 weeks, 3 months |

**Правило:** секреты бэкапа (пароли restic) запрещено хранить в коде скриптов. Только в `/home/openclaw/.openclaw/.secrets/*.env` (chmod 600).


---

## Обновление OpenClaw

Ответственный: devops (Иллидан). Cron: ежедневно 10:00 MSK.
Порядок канарейки: Illidan → Thrall → Sylvanas.
Полная процедура: `scripts/update-openclaw-all.sh` и `skills/safe-update/`.

---

## Heartbeats

| Агент | Частота | Модель | Активные часы |
|-------|---------|--------|---------------|
| Тралл | 2h | Grok 4.1 Fast | 06:00-23:00 MSK |
| Сильвана | 1h | Grok 4.1 Fast | -- |
| Артас | 1h | Grok 4.1 Fast | -- |
| Кельтас | 2h | Grok 4.1 Fast | -- |
| Иллидан | 1h | Grok 4.1 Fast | -- |

**Принцип:** heartbeat -- дешёвая модель (Grok 4.1 Fast через OpenRouter). Не использовать Opus/Codex/Gemini для heartbeat.

---

## Cron jobs (реестр)

Полный реестр cron jobs: `shared/cron-registry.md` (не дублируется в конституции).
Каждый сервер: Thrall (7 cron), Sylvanas (7 cron), Illidan (8 cron).

### Правила cron

- Каждый cron обязан иметь явную модель (не default)
- OAuth-модели (Codex, Sonnet, Opus) предпочтительны -- $0
- Kimi K2.5 -- только где нет OAuth (Update Monitor, heartbeats)
- Sonnet запрещён в cron (как и везде)
- Правило молчания: если всё ОК -- не алертить принца
- Алерт только при нарушении/аномалии

---

## Ежедневный аудит конституции (Illidan)

Иллидан выполняет ежедневный аудит соответствия системы конституции двумя независимыми моделями (Codex 09:00 MSK, Gemini Pro 09:30 MSK).

### 8 категорий аудита

1. **Модели** -- правильные модели на всех серверах, Flash отсутствует
2. **Безопасность** -- UFW active, .secrets 700, ownership openclaw
3. **Git Workflow** -- branch protection, CODEOWNERS enforced
4. **Бэкапы** -- restic snapshots не старше 25ч на всех серверах
5. **Конституция** -- одинаковый commit hash на 3 серверах
6. **Heartbeats** -- все активны, без ошибок
7. **groupPolicy** -- allowlist на всех серверах
8. **Задачная система** -- нет задач в inbox >4ч, нет задач в active >48ч без обновления

### Принцип двух моделей

- Две разные модели выполняют один и тот же аудит независимо
- Если результаты расходятся -- требуется разбор (ложные PASS опаснее ложных FAIL)
- Обе модели выполняют реальные команды на серверах, не доверяют памяти
- Отчёт: PASS X/8 + детали нарушений

### При обнаружении нарушения

- P0/P1: немедленный алерт принцу
- P2: записать в inbox, исправить при следующем heartbeat
- Повторное нарушение (2+ дня подряд): эскалация до P1
