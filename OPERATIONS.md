# Операционная модель Orgrimmar

_Связующий слой между конституцией и pipeline'ами. Описывает КАК работает система._

---

## Роли

Система описывает роли, не агентов. Один агент = одна или несколько ролей.

| Роль | Зона | Может | Не может |
|------|------|-------|----------|
| **coordinator** | Оркестрация, маршрутизация | Распределять задачи агентам Sylvanas, ревьюить планы, мониторить все серверы. Тралл/Иллидан -- только через задачную систему (shared/tasks/) или принца | Править архитектурные решения coder'а. Командовать devops по инфраструктуре |
| **coder** | Код, архитектура, скиллы | Писать код, создавать PR, деплоить | Менять чужие AGENTS.md без одобрения |
| **devops** | Инфра, мониторинг, recovery | Рестартовать сервисы, чинить серверы | Менять бизнес-логику агентов |
| **monitor** | Отслеживание внешних данных | Алертить, собирать данные | Мониторить серверы (это devops) |
| **creator** | Контент, дизайн | Создавать контент, публиковать | Менять инфраструктуру |
| **finance** | Бюджет, расходы | Отслеживать траты, алертить о лимитах | Управлять подписками (только принц) |
| **worker** | Рутина, автоматизация | Выполнять простые задачи | Брать задачи вне своей роли |

---

## Задачная система

Все входящие от принца проходят классификацию перед обработкой.

### Классификация сообщений

| Тип | Критерий | Маршрут |
|-----|----------|---------|
| **ЗАДАЧА** | Есть последствие невыполнения | inbox → triage → active → done |
| **ИДЕЯ** | Ценная мысль, нет дедлайна | ideas/ (отдельный трек) |
| **ЗАПРОС** | Нужен ответ сейчас | ответить, не записывать |
| **ОТВЕТ** | Реакция на вопрос агента | обновить существующую задачу |

**Правило классификации:** «Если не сделать -- что-то сломается или потеряется?»
- Да → ЗАДАЧА
- Нет, но ценно → ИДЕЯ
- Нет → ЗАПРОС/ОТВЕТ

**Приоритеты задач:** P0 (срочно) → P1 (надо) → P2 (попробуй) → P3 (бэклог).

### Роли в задачной системе

| Роль | Что делает |
|------|------------|
| **triage** (coordinator) | Классифицирует inbox, назначает исполнителя |
| **executor** (все агенты) | Выполняют назначенные задачи, обновляют статус |
| **watchdog** (monitor) | Следит за зависшими задачами, пингует исполнителей |
| **enforcer** (monitor) | Проверяет качество, подгоняет без снижения стандартов |

### Неприкосновенность inbox

- Удалять из inbox **ЗАПРЕЩЕНО** -- любому агенту, включая coordinator
- Допустимые действия: triage (перемещение в active) или архивация (в done с причиной)
- Inbox = лог намерений принца. Потеря записи = нарушение конституции

### Shadow logging

- Все сообщения принца сохраняются, даже ЗАПРОСЫ и ОТВЕТЫ
- Ни одно сообщение принца не должно потеряться
- Идеи, упомянутые повторно, кристаллизуются в задачу (из ideas/ → inbox)

---

## Маршрутизация задач

Switch-case по тегам. Неизвестная задача -> coordinator -> принц.

| Теги задачи | Роль | Pipeline | Домен жизни |
|-------------|------|----------|-------------|
| задача, поручение | coordinator | task-system (triage) | -- |
| код, фича, баг, PR | coder | dev-pipeline | Бизнес |
| сервер, диск, RAM, деплой | devops | -- | Бизнес |
| агент тупит, ложный алерт | coder | agent-bugfix | Бизнес |
| крипто, инвестиции | finance | -- | Финансы |
| контент, пост, видео | creator | content-pipeline | Бизнес |
| бюджет, расходы, подписки | finance | -- | Финансы |
| напоминание, рутина, расписание | worker | -- | Продуктивность |
| здоровье, сон, тренировка | monitor | -- | Здоровье, Сон |
| семья, дети, отношения, даты | worker | -- | Семья |
| обновление агентов | coder | safe-update |
| новый pipeline | coder | pipeline-builder |
| идея, стратегия | coordinator + coder | brainstorm-pipeline |
| аудит системы | coder | self-review |
| неизвестно | coordinator | -- (эскалация принцу) |

---

## Распределение моделей по задачам (model routing)

Стандарт для pipeline-воркеров. Источник: `skills/_base/PIPELINE-BASE.md`.

| Задача | Модель | Алиас | Обоснование |
|--------|--------|-------|-------------|
| SPEC / PLANNING | Opus | `cc-opus` | Архитектурные решения |
| GATHER / RESEARCH | Kimi K2.5 | `kimi` | Дёшево, достаточно для сбора данных |
| GATHER (>50KB) | Gemini 3.1 Pro | `gemini` | 2M контекст |
| Написание кода / FIX | Sonnet 4.6 | `claude` | Лучший кодер, подписка $0 |
| VERIFY | Sonnet 4.6 | `claude` | Подписка $0 |
| REVIEW (всегда) | Gemini 3.1 Pro | `gemini` | Обязателен в каждом review |
| REVIEW (HIGH risk) | Codex + Gemini + Opus | все 3 | Triple review |
| DIVERGE (brainstorm) | Codex + Gemini + Sonnet | все 3 | Разнообразие моделей |

**Принцип:** Gemini обязателен в каждом review. Triple review (3 модели) -- только для HIGH risk (P0/P1 баги, security, multi-server деплой, финансовый код).

---

## Эскалация

| Триггер | Уровень | Действие |
|---------|---------|----------|
| Задача вне роли | L1 | Передай coordinator'у |
| 3 попытки фикса провалились | L2 | Стоп, доклад принцу |
| Сервер/агент недоступен | L2 | devops чинит; если devops недоступен -> coder |
| Перерасход API > $20/сутки | L3 | Стоп, одобрение принца |
| Конфликт между агентами | L3 | Эскалация принцу |
| Critical security issue | L3 | Немедленно принцу |

---

## Health (OODA loop)

Каждый агент с heartbeat выполняет цикл:

```
Observe:  проверь свою зону (метрики, логи, статусы)
Orient:   сравни с ожидаемым состоянием
Decide:   отклонение > порог? -> алерт. Всё ок? -> молчи.
Act:      алерт принцу / автофикс (если в рамках роли) / эскалация
```

**Правило:** heartbeat = молчание если всё ок. Алерт только при проблеме.

---

## Связи pipeline'ов

```
self-review  ──обнаружил баг──>  agent-bugfix
self-review  ──нужен апдейт──>  safe-update
agent-bugfix ──нужен код──>     dev-pipeline
dev-pipeline ──готов деплой──>  safe-update
brainstorm   ──решение принято──> dev-pipeline
```

---

## Добавление нового агента

**Только по прямому приказу принца.** Ни один агент не может создать другого агента по собственной инициативе.

1. Выбери роль(и) из таблицы ролей выше
2. Добавь строку в ROSTER.md (shared/)
3. Создай AGENTS.md, SOUL.md, HEARTBEAT.md
4. Настрой openclaw.json (модель, скиллы, heartbeat)
5. Скопируй скиллы роли в shared dir
6. Проверь: `systemctl is-active openclaw`
7. Smoke test: агент отвечает, скиллы грузятся, heartbeat работает

Удаление: обратный порядок (7→1), убери из ROSTER.md.
