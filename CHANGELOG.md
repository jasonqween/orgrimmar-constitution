# Changelog

## 2026-02-25 (8) -- Budget API + Silvana Elevation + Cross-check Fixes

Бюджетное правило, повышение Сильваны, фиксы по cross-check аудиту.

### PRINCIPLES.md
- **Иерархия:** Сильвана повышена до координатора ВСЕЙ сети. Может давать задачи и мониторить Тралла и Иллидана.
- **Ограничение:** Сильвана НИКОГДА не правит архитектурные решения Тралла (код, инфра, конфиги). Может запросить задачу, но не переопределять КАК.
- Тралл и Иллидан сохраняют прямой доступ к принцу.

### CHARTER.md
- **Бюджет API ($20/сутки):** новая секция. Общий лимит на ВСЮ сеть (8 агентов, 3 сервера). Агент проверяет фактические лимиты API, расширяет самостоятельно в пределах $20/сутки. Выше -- одобрение принца.
- **КРАСНАЯ ЗОНА:** убран старый порог «траты > $50» (заменён на $20/сутки API).
- **Нельзя:** «$20 за задачу» заменён на «суточный лимит перерасхода API $20».
- **coordinator:** может давать задачи ВСЕМ агентам, мониторить все серверы. НИКОГДА не правит архитектурные решения coder'а.

### OPERATIONS.md
- **coordinator:** «Не может давать задачи вне сервера» → «Может давать задачи ВСЕМ, мониторить все серверы. Не может править архитектуру coder'а».
- **Эскалация:** «Бюджет > $20 за задачу» → «Перерасход API > $20/сутки».

### CONVENTIONS.md (shared/_ref/)
- **Leveling:** убраны конфликтующие названия (Operator/Advisor/Observer) → L3/L2/L1 как в CHARTER.md.
- **Autonomous Bug Fixing:** добавлено обязательное логирование в форум + отчёт.

### Причина
- Cross-check аудит (3 kimi-воркера): найдено 5 внутренних конфликтов + 4 конфликта в AGENTS.md агентов
- Решение принца: $20/сутки общий лимит на все API всей сети (не per-agent, не per-task)
- Решение принца: Сильвана наравне с Траллом и Иллиданом, но без права менять архитектуру

---

## 2026-02-25 (7) -- Autonomy Zones + Rule of Three

Формализация автономности L3 coder'а и обновление правила попыток.

### CHARTER.md
- **L3 расширенная автономия (роль coder):** новая секция с тремя зонами -- ЗЕЛЁНАЯ (без одобрения), ЖЁЛТАЯ (принц даёт задачу, дальше сам), КРАСНАЯ (всегда одобрение)
- **Правило 3 попыток:** заменено «2 попытки → стоп» на «3 попытки → стоп» в эскалации
- **Бюджет задачи:** L3 coder получает порог $50 (default остаётся $20)

### OPERATIONS.md
- **Эскалация:** «2 попытки фикса провалились» → «3 попытки фикса провалились»

---

## 2026-02-24 (6) -- Constitution Audit Fixes

Внешний аудит конституции (независимая LLM) выявил 10 проблем. Все исправлены.

### PRINCIPLES.md
- **P1 vs P2 конфликт устранён:** P1 (безопасность) теперь непереопределяем. Приказ принца выше всего КРОМЕ P1. Опасное действие НЕ выполняется даже по подтверждению -- формула отказа.
- **Приказ / делегирование / маршрутизация:** три типа назначения работы определены явно. Делегирование от coordinator'а валидно в рамках приказа принца.
- **«Не создавать дайджесты»:** уточнено «дайджесты конституции» (утренние/вечерние дайджесты coordinator'а разрешены).

### CHARTER.md
- **Subagents:** явно наследуют ВСЕ ограничения конституции. Действия логируются как действия родителя.
- **Глоссарий:** определены 8 ключевых терминов (деструктивные команды, значимые изменения, low/high-risk, задача, одобрение, уведомление, сомнение).
- **L3 auto-fix:** allowlist конкретных команд вместо описательного. Запрет удаления свежих логов (<24ч). Обязательный отчёт в форум.
- **Режим «Принц недоступен»:** что разрешено L3/L2/L1 при инциденте без связи с принцем.
- **Incident Response:** 6 шагов (contain→notify→rotate→audit→restore→postmortem), 3 severity уровня.
- **Backup Policy:** Restic, cross-server + DO Spaces, retention, расписание.
- **«Игнорировать приказ принца»:** добавлена оговорка «кроме случаев нарушения P1».

### OPERATIONS.md
- **Добавление агента:** явно «только по прямому приказу принца».

### Причина
- Внешний аудит: оценка 5.5/10, выявлены логические коллизии, отсутствие incident response, неопределённые термины
- Все 10 замечаний исправлены в одном PR

---

## 2026-02-24 (5) -- Security Policy

### CHARTER.md
- Новая секция «Безопасность» с 4 подразделами:
  - Секреты и ключи: запрет plaintext в memory/git, ссылки только по имени
  - Сетевая безопасность: обязательный UFW, SSH только через Tailscale, hardened sshd
  - Действия агентов: запрет вывода ключей в чат/логи, env vars вместо inline
  - Аудит: периодические security scans, pre-commit hooks, проверка при self-review

### Причина
- Security audit (3 kimi-воркера): найдено 4 CRITICAL, 4 HIGH, 5 MEDIUM уязвимостей
- API ключи в plaintext в memory файлах (MEMORY.md, HOT_MEMORY.md)
- PermitRootLogin yes на всех 3 серверах
- UFW не установлен на Thrall, SSH открыт для интернета на всех серверах
- Все исправлено: UFW hardened, SSH hardened, секреты вычищены из памяти

---

## 2026-02-24 (4) -- Update Safety Validation

### CHARTER.md
- Добавлена секция «Обновление OpenClaw» с обязательной pre/post валидацией
- Канарейка: Illidan → Thrall → Sylvanas (обязательный порядок)
- НИКОГДА не обновлять все серверы одновременно
- При FAIL post-check -- остановить раскатку, доложить принцу
- Обязательная проверка CHANGELOG на BREAKING changes

### Причина
- Brainstorm «защита от breaking changes»: 6 вариантов (3 pragmatic + 3 creative)
- Выбран Constitution-Driven Validation -- формализация правил обновления
- Скрипт `pre-update-check.sh`: 7 категорий проверок (config, service, skills, integrations, constitution, memory, connectivity)
- Интеграция в `update-openclaw-all.sh` (pre/post gate на каждом сервере)

---

## 2026-02-24 (3) -- Аудит и поправки

### CHARTER.md
- L3 auto-fix: агенты уровня L3 могут выполнять low-risk автофиксы без одобрения (restart, vacuum, log rotation). High-risk -- всегда одобрение принца.
- Cron delivery: каждый cron job обязан иметь явный `channel` в delivery config.

### PRINCIPLES.md
- Усилена формулировка pipeline-чеклиста: «НИКОГДА не начинай задачу без проверки pipeline»
- Добавлен явный запрет: «НИКОГДА не создавай pipeline вручную -- только через pipeline-builder»

### Причина
- L3 auto-fix: Иллидан фактически выполняет автофиксы, но граница не была формализована
- Cron delivery: 4 cron jobs были сломаны из-за отсутствия явного channel
- Pipeline: Тралл дважды нарушил мягкую формулировку правила

Автор: Тралл (qwwiwi), ожидает одобрение принца (jasonqween)

## 2026-02-24 (2)
- CHARTER: добавлен обязательный процесс «Agent Bugfix Pipeline» (6 фаз: TRIAGE → GATHER → DIAGNOSE → FIX → VERIFY → LEARN)
- Запрещено чинить агентов вручную без прохождения pipeline
- Причина: 3 раза подряд Иллидан слал ложные JWT алерты, каждый раз чинили вручную вместо системного подхода
- Автор: Тралл, одобрено принцем

## 2026-02-24
- PRINCIPLES: добавлен принцип «Сначала проверь pipeline» -- перед задачей проверяй наличие готового pipeline
- PRINCIPLES: обновлён «Сначала план, потом действие» -- два режима: по pipeline (без остановок) и без регламента (план → одобрение → действие)
- Автор: Тралл, одобрено принцем

## v1.1.0 (2026-02-23)

Уроки первого дня -- 4 новых принципа в PRINCIPLES.md:
- «Сначала план, потом действие» -- не кодить без одобрения
- «Вопрос -- это вопрос» -- мнение, не действие
- «Инструкции выше памяти» -- при конфликте инструкции приоритетнее
- «Каждое слово важно» -- конституция читается полностью
- «Staged rollout» -- канарейка перед массовыми изменениями

## v1.0.0 (2026-02-23)

Первая версия конституции.

- Создан PRINCIPLES.md: миссия, 4 приоритета (P1-P4), фундаментальные принципы
- Создан CHARTER.md: роли, границы, процессы, эскалация, коммуникация, уровни доступа
- Создан proposals/TEMPLATE.md: шаблон для предложений от агентов

## 2026-02-24: Governance v2

### Добавлено
- OPERATIONS.md -- операционная модель (маршрутизация, эскалация, health, pipeline связи)
- Чеклист добавления/удаления агента

### Изменено
- CHARTER.md -- рефакторинг через роли вместо имён агентов
- Убрано дублирование pipeline'ов (перенесено в OPERATIONS.md)
- Ссылки на ROSTER.md (shared/) и OPERATIONS.md

### Принципы
- Система описывает РОЛИ, не агентов
- Добавление агента = 1 строка в ROSTER + назначение роли
- OPERATIONS.md < 3.5KB (экономия токенов)
